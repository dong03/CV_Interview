# 数字图像处理

## 图像压缩
### 压缩步骤
```
- Image
- Mapper(映射器，空域到频域，JPEG：8 x 8 DCT) 
    - why DCT？ DFT假设block间是重复的，DCT假设blaock间是连续的。且如果图像满足马尔科夫链，DCT是最优卡洛变换
- Quantilizor(量化器，连续值变离散值(如256位)
- Symbol Encoder(编码器，进一步节省存储空间，e.g. 霍夫曼编码)
- 解码(依据symbol encoder的编码规则反变换)
- 反变换(不需要量化)
- Compressed Image
```

### 霍夫曼量化

为什么可以压缩？存在冗余。编码冗余；像素间冗余；视觉冗余。

- 根据出现的频率编码，给高频率更短的编码，节省平均位数
```
- 按照值出现的概率排序
- 取最后两项合并，重新排序（最小的为左节点，次小右节点） 
- 重复至仅剩两项
- 倒着赋值，左节点0， 右节点1
```
- 可以保证按位接收编码时不会有重复的（不同值没有公共的头）
- 确定是否值得做霍夫曼编码？
    -  <font color=red>计算信息熵，$-\sum P{log}P$,  TBD</font>

### 其他压缩
- JPEG-LS： predict error,预测够好的话有很多0，用霍夫曼编码省空间
    - predict error filter，和预测值的差，强调基于local的信息，bayarconv的原理，不太可能具有语义信息，而是广泛存在于local结构中
- MPEG：视频压缩，利用前一帧的相同pixel/region 预测当前帧的值
- 编码方式
    - 统计编码：根据概率分布设计可变长码，接近信息熵（霍夫曼编码）
    - 算数编码：利用编码符号的联合概率，使用浮点数代替输入符号
    - 预测编码（类似上面的error predictor）
    - 变换编码：在频域集中的地方编码


------------------
## 图像增强
- 对比度增强：线性/非线性变换，根据pixel值直接映射（是点处理）
    - 点处理
    - 局部处理（3*3模板滤波）
    - 全局处理（灰度图均衡）
- 低阶比特平面包含更多灰度细节，高阶包含视觉更丰富的元素
### 直方图匹配
把灰度直方图修正为期望分布
直方图均衡：特殊情况，希望每个色阶的概率一致
```
1. 统计累计灰度概率（最终是1的那种，四舍五入）
2. 映射：当前像素值 -> 当前像素值 x 灰度阶数
```

### 微分
增强图像细节，二阶比一阶好，实现起来更容易
- 二阶：拉普拉斯算子（简化计算，xy方向直接求和），各向同性（周边-中间，和顺序没关系）
  - 对噪声响应强烈
  - 一般不用于边缘检测，而是判断亮区暗区（梯度小于0亮区，大于0暗区）
  - 可增强图像中灰度突变的区域，减弱灰度的缓慢变化区域，叠加原图为锐化

- 一阶：sobel算子（没有各向同性，有不同的权重。把2改为$sqrt(2)$有各向同性
  - 对噪声有平滑作用（对featuremap再做是不是用处不大了？反而有不好的影响，前面已经pooling那么多了，是不是可以换用拉普拉斯）

- canny：
  - 要对噪声鲁棒（先做高斯滤波）
  - 边缘要定位在真实位置的中心（sobel太宽，要对梯度做非极大抑制，仅保留最大梯度）
  - 边缘要找全（双阈值和连接边缘法，大于强阈值的一定是，小于弱阈值的一定不是，中间状态以周边有无强边缘判断）

- <font color=red>其他  TBD</font>

------------------
## 图像校正
### 霍夫检测

需要先做边缘二值图像

#### 直线检测

- 使用极坐标，有$\gamma = x\cos\theta + y\sin\gamma$表示所有过(x,y)的直线，
则对$(\theta, \gamma)$有一条正弦曲线，上面的每个点代表一条过(x,y)的直线
- 不同(x,y)形成的正弦曲线的交点代表过该两点的一条直线
- 根据交点上曲线的数量卡阈值，判断该条直线上有多少个点，进而判读是否为同一条直线

#### 圆检测

- 使用$(x,y,r)$表示过x，y，以r为圆心的圆，那经过某一点的所有圆就是一个圆锥，因为r从0开始增加么。考察是否有足够多点的圆锥（r从0开始增加）有公共交点
- 检测其他形状也需要从空间分布变成统计学分布


### 角点检测（FAST, SIFT)
- FAST: 若某像素与其他差距大，则为角点
- SIFT：尺度不变性特征，在不同尺度、角度寻找关键点，并计算该点的方向。找不因为光照、仿射变换、噪声等变化的点（边缘点、角点、亮度异常点）

### 校正
- 基于轮廓：灰度二值化后提取轮廓（包围矩形），获得角度然后旋转校正。用于车牌、证件等有明显轮廓的；
- 基于直线：霍夫变换找所有直线，求角度均值，旋转。适用文本等无明显边界的；
- 图像拼接：提取特征点（角点），特征点匹配、叠加、处理边界

### HOG特征提取

使用局部梯度直方图代表图像特征

> - 计算每个像素点的梯度大小和方向（水平、垂直方向的单位微分，幅值平方求和，方向arctan
> - 划分若干ceil（e.g. 8*8），按照方向划分9个bin（20°一个），增加幅值
> - 考虑到对光照、阴影、边缘变化的鲁棒性，若干ceil构成一个block，对比度归一化（block间可以有overlap）

### 开闭操作

- 膨胀：模板范围内最大值赋予参考点（中心），会使亮的区域扩大
- 腐蚀：最小值赋予参考点，使亮的区域缩小

假设小物体是亮色，背景是暗色

- 开操作：先腐蚀再膨胀，一处小的明亮区域，在细的地方分离前景
- 闭操作：先膨胀再腐蚀，填充细小空洞

	### 图像拼接

- 特征提取：关键点检测（角点、边缘信息）
- 图像配准：把两站图的关键点align起来，关注局部信息，如SSD（窗口内像素差值的平方和，越小相似度越高）
- 剔除异常点：RANSAC，随机选择若干，拟合单位变换矩阵，判断局内点、局外点，直到可以接受的阈值

- 变形融合：使用RANSAC的单位变换矩阵仿射变换，根据角点计算偏移量，再对交叉地区执行局部平均池化调整融合边界
